<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Study Planner</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' rx='20' fill='%233B82F6'/%3e%3cpath d='M15,42 L50,60 L85,42 M15,42 L50,24 L85,42 L50,60 Z M32,51 L32,68 C32,78 50,82 50,82 C50,82 68,78 68,68 L68,51 M85,42 L85,60' stroke='white' stroke-width='6' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.625rem 0.75rem; border-radius: 0.5rem; font-size: 0.875rem; font-weight: 500; transition: color 0.2s, background-color 0.2s; }
        .nav-link i { width: 1.25rem; height: 1.25rem; }
        .active-nav-link { background-color: #eef2ff; color: #3b82f6; }
        .dark .active-nav-link { background-color: rgba(59, 130, 246, 0.15); color: #93c5fd; }
        .modal-container { position: fixed; inset: 0; z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay { position: absolute; inset: 0; background-color: rgba(10, 10, 10, 0.75); backdrop-filter: blur(4px); }
        .modal-panel { position: relative; width: 100%; max-width: 28rem; background-color: white; border-radius: 1rem; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .dark .modal-panel { background-color: #111827; }
        .status-badge-Pending { background-color: #fef9c3; color: #a16207; border: 1px solid #fde047; }
        .dark .status-badge-Pending { background-color: rgba(234, 179, 8, 0.1); color: #fde047; border-color: rgba(234, 179, 8, 0.3); }
        .status-badge-In-Progress { background-color: #dbeafe; color: #1d4ed8; border: 1px solid #93c5fd; }
        .dark .status-badge-In-Progress { background-color: rgba(59, 130, 246, 0.1); color: #93c5fd; border-color: rgba(59, 130, 246, 0.3); }
        .status-badge-Completed { background-color: #dcfce7; color: #15803d; border: 1px solid #86efac; }
        .dark .status-badge-Completed { background-color: rgba(74, 222, 128, 0.1); color: #86efac; border-color: rgba(74, 222, 128, 0.3); }
    </style>
</head>
<body class="bg-white dark:bg-black text-black dark:text-white">

    <div id="login-screen" class="flex flex-col items-center justify-center min-h-screen p-4 sm:p-6 lg:p-8">
        
        <div class="text-center mb-10">
            <div class="inline-block p-3 bg-blue-600 rounded-xl mb-4">
                <i data-lucide="graduation-cap" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-3xl font-bold text-black dark:text-white">Welcome to Study Planner</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Organize your academic tasks and achieve your study goals</p>
        </div>

        <div class="w-full max-w-sm bg-white dark:bg-gray-900 p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
            <div class="text-center">
                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Sign in to your account</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Each student gets their own secure account with separate task lists.</p>
            </div>

            <div class="mt-6 flex justify-center w-full">
                <button id="firebase-login-btn" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-200 font-medium py-2.5 px-4 rounded-lg transition-colors">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google logo">
                    <span>Sign in with Google</span>
                </button>
            </div>
            
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-6 text-center">
                <i class="w-3 h-3 inline-block -mt-px" data-lucide="lock"></i> Your data is securely stored and only accessible by you.
            </p>
        </div>

        <div class="mt-8 text-center w-full max-w-md">
             <h3 class="font-semibold text-black dark:text-white">Why sign in?</h3>
             <ul class="mt-4 space-y-2 text-gray-600 dark:text-gray-400 text-sm">
                 <li class="flex items-center justify-center gap-2">
                     <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                     <span>Keep your tasks safe and accessible from any device</span>
                 </li>
                 <li class="flex items-center justify-center gap-2">
                     <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                     <span>Personalize your planner and track your progress</span>
                 </li>
                  <li class="flex items-center justify-center gap-2">
                     <i data-lucide="check-circle" class="w-4 h-4 text-green-500"></i>
                     <span>Securely backed up with your Google account</span>
                 </li>
             </ul>
        </div>
    </div>
    
    <div id="app-container" class="flex h-screen hidden">
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 bg-white dark:bg-gray-900 border-r border-gray-200 dark:border-gray-700 shadow-sm z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <div class="p-6 border-b border-gray-100 dark:border-gray-700">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-600 rounded-lg"><i data-lucide="graduation-cap" class="w-6 h-6 text-white"></i></div>
                        <h1 class="text-lg font-bold text-black dark:text-white">Study Planner</h1>
                    </div>
                </div>
                <nav class="flex-1 p-4">
                    <ul class="space-y-2">
                        <li><a href="#/" class="nav-link" data-page="dashboard"><i data-lucide="home"></i> Dashboard</a></li>
                        <li><a href="#/tasks" class="nav-link" data-page="tasks"><i data-lucide="check-square"></i> Tasks</a></li>
                        <li><a href="#/calendar" class="nav-link" data-page="calendar"><i data-lucide="calendar"></i> Calendar</a></li>
                        <li><a href="#/analytics" class="nav-link" data-page="analytics"><i data-lucide="bar-chart-3"></i> Analytics</a></li>
                        <li><a href="#/settings" class="nav-link" data-page="settings"><i data-lucide="settings"></i> Settings</a></li>
                    </ul>
                </nav>
                <div class="p-4 border-t border-gray-100 dark:border-gray-700">
                    <div class="bg-gray-50 dark:bg-gray-800/50 rounded-lg p-3 mb-3">
                        <div class="flex items-center gap-3">
                            <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="User avatar">
                            <div class="flex-1 min-w-0">
                                <div id="user-name" class="text-sm font-medium text-gray-900 dark:text-white truncate"></div>
                                <div id="user-email" class="text-xs text-gray-600 dark:text-gray-400 truncate"></div>
                            </div>
                        </div>
                    </div>
                    <button id="sign-out-btn" class="w-full flex items-center gap-2 px-3 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i>Sign Out</button>
                </div>
            </div>
        </aside>

        <button id="mobile-menu-button" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-white dark:bg-gray-700 rounded-lg shadow-md border border-gray-200 dark:border-gray-600"><i data-lucide="menu" class="w-6 h-6 text-gray-600 dark:text-gray-300"></i></button>

        <div class="flex-1 lg:ml-64 transition-all duration-300">
            <main id="main-content" class="p-4 lg:p-8 pt-20 lg:pt-8 h-screen overflow-y-auto"></main>
        </div>
    </div>

    <div id="templates" class="hidden">
        <div id="dashboard-page">
            <div class="space-y-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Dashboard</h1>
                    <p class="text-gray-600 dark:text-gray-400">Welcome back! Here's your academic progress overview.</p>
                </div>
                <div id="dashboard-stats" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                <div id="dashboard-overview" class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"></div>
                <div id="dashboard-due-soon" class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"></div>
            </div>
        </div>
        <div id="tasks-page">
            <div class="space-y-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Tasks</h1>
                        <p class="text-gray-600 dark:text-gray-400">Manage all your academic assignments and study tasks.</p>
                    </div>
                    <button id="open-add-modal-btn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors font-medium"><i data-lucide="plus" class="w-5 h-5"></i>Add Task</button>
                </div>
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-4"><div id="filter-buttons" class="flex items-center gap-4"></div></div>
                <div id="full-task-list" class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700"></div>
            </div>
        </div>
        <div id="calendar-page">
            <div class="space-y-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Calendar</h1>
                    <p class="text-gray-600 dark:text-gray-400">View all your tasks and deadlines in a monthly calendar format.</p>
                </div>
                <div id="calendar-container" class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"></div>
                <div id="calendar-info-section" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>
        </div>
        <div id="analytics-page">
            <div class="space-y-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Analytics</h1>
                    <p class="text-gray-600 dark:text-gray-400">Track your academic progress and study habits.</p>
                </div>
                <div id="analytics-key-metrics" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
                
                <div id="analytics-weekly-progress" class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"></div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div id="analytics-subject-performance" class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 h-full"></div>
                    <div id="analytics-study-insights" class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 h-full"></div>
                </div>
            </div>
        </div>
        <div id="settings-page">
            <div class="space-y-8">
                <div><h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">Settings</h1><p class="text-gray-600 dark:text-gray-400">Customize your Study Planner experience and manage your data.</p></div>
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"><h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">Preferences</h3><div id="settings-preferences" class="space-y-6"></div></div>
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"><h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">Data Management</h3><div id="settings-data-management" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></div>
                <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6"><h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">About Study Planner</h3><div id="settings-about" class="space-y-4 text-sm text-gray-600 dark:text-gray-400"></div></div>
            </div>
        </div>
    </div>
    
    <div id="task-modal" class="modal-container hidden">
        <div class="modal-overlay"></div><div class="modal-panel"><div class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700"><h3 id="modal-title" class="text-lg font-semibold text-gray-900 dark:text-white"></h3><button id="modal-close" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-white rounded-lg"><i data-lucide="x"></i></button></div><div class="p-6"><form id="task-form" class="space-y-4"></form></div></div>
    </div>
    <div id="date-tasks-modal" class="modal-container hidden">
        <div class="modal-overlay"></div>
        <div class="modal-panel">
            <div class="p-6 flex justify-between items-center border-b border-gray-200 dark:border-gray-700">
                <h3 id="date-tasks-modal-title" class="text-lg font-semibold text-gray-900 dark:text-white"></h3>
                <button id="date-tasks-modal-close" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-white rounded-lg"><i data-lucide="x"></i></button>
            </div>
            <div id="date-tasks-modal-content" class="p-6 max-h-96 overflow-y-auto"></div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- PASTE YOUR FIREBASE CONFIG HERE ---
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY_HERE",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let tasks = [];
        let settings = { notifications: false, reminderTime: 24 };
        let currentFilter = 'All';

        // --- AUTH HANDLERS ---
        const loginBtn = document.getElementById('firebase-login-btn');
        const signOutBtn = document.getElementById('sign-out-btn');

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => alert("Login Error: " + error.message));
        });

        signOutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            });
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                showApp();
            } else {
                currentUser = null;
            }
        });

        function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Update UI with user info
            document.getElementById('user-avatar').src = currentUser.photoURL;
            document.getElementById('user-name').textContent = currentUser.displayName;
            document.getElementById('user-email').textContent = currentUser.email;
            
            // Initialize the rest of the application
            initApp();
            
            // Start listening to Firebase Database
            const userRef = ref(db, 'users/' + currentUser.uid);
            onValue(userRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    tasks = data.tasks || [];
                    settings = data.settings || { notifications: false, reminderTime: 24 };
                } else {
                    tasks = [];
                }
                // Refresh current view
                window.dispatchEvent(new HashChangeEvent("hashchange")); 
            });
        }
    
        function saveToFirebase() {
            if (!currentUser) return;
            set(ref(db, 'users/' + currentUser.uid), {
                tasks: tasks,
                settings: settings
            });
        }

        const applySystemTheme = () => {
            const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        };
        applySystemTheme();
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySystemTheme);

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons(); 
        });

        // --- APP LOGIC ---
        function initApp() {
            const mainContent = document.getElementById('main-content'),
                  templates = document.getElementById('templates');
            
            // Holds the Chart.js instance to avoid duplication
            let analyticsChart = null;

            const formatDate = (d) => {
                if (!d) return '';
                const [year, month, day] = d.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' });
            };
            
            const renderPage = (page) => {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active-nav-link', l.dataset.page === page));
                mainContent.innerHTML = templates.querySelector(`#${page}-page`).innerHTML;
                
                // Cleanup chart if leaving analytics page
                if (page !== 'analytics' && analyticsChart) {
                    analyticsChart.destroy();
                    analyticsChart = null;
                }

                if (page === 'dashboard') setupDashboardPage();
                if (page === 'tasks') setupTasksPage();
                if (page === 'calendar') setupCalendarPage();
                if (page === 'analytics') setupAnalyticsPage();
                if (page === 'settings') setupSettingsPage();
                lucide.createIcons();
            };

            function setupDashboardPage() {
                const total = tasks.length, completed = tasks.filter(t => t.status === 'Completed').length;
                
                const reminderHours = settings.reminderTime || 24;
                const dueSoon = tasks.filter(t => {
                    if (t.status === 'Completed' || !t.dueDate) return false;
                    const timeUntilDue = (new Date(t.dueDate).getTime() - new Date().getTime()) / 36e5;
                    return timeUntilDue > 0 && timeUntilDue <= reminderHours;
                });

                const stats = [
                    { label: 'Total Tasks', value: total, icon: 'book-open' }, { label: 'Completed', value: completed, icon: 'bar-chart-3' },
                    { label: 'Due Soon', value: dueSoon.length, icon: 'calendar' }, { label: 'Success Rate', value: `${total > 0 ? Math.round(completed/total*100) : 0}%`, icon: 'trending-up' }
                ];
                document.getElementById('dashboard-stats').innerHTML = stats.map(s => `
                    <div class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <div><p class="text-sm font-medium text-gray-600 dark:text-gray-400">${s.label}</p><p class="text-2xl font-bold text-gray-900 dark:text-white">${s.value}</p></div>
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/50 rounded-lg"><i data-lucide="${s.icon}" class="w-6 h-6 text-blue-600 dark:text-blue-400"></i></div>
                    </div>`).join('');
                
                const overviewEl = document.getElementById('dashboard-overview');
                overviewEl.innerHTML = `<h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Overview</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg"><p class="text-sm text-gray-600 dark:text-gray-300">Total</p><p class="font-bold text-lg text-gray-900 dark:text-white">${total}</p></div>
                        <div class="p-4 bg-green-50 dark:bg-green-900/50 rounded-lg"><p class="text-sm text-green-800 dark:text-green-300">Completed</p><p class="font-bold text-lg text-green-600">${completed}</p></div>
                        <div class="p-4 bg-yellow-50 dark:bg-yellow-900/50 rounded-lg"><p class="text-sm text-yellow-800 dark:text-yellow-300">Pending</p><p class="font-bold text-lg text-yellow-600">${total-completed}</p></div>
                    </div>`;

                const getReminderLabel = (hours) => {
                    if (hours < 24) return `Next ${hours} Hours`;
                    if (hours === 24) return `Next 24 Hours`;
                    if (hours === 168) return `Next 7 Days`;
                    return `Next ${hours / 24} Days`;
                }
                const dueSoonLabel = getReminderLabel(reminderHours);
                const dueSoonEl = document.getElementById('dashboard-due-soon');
                dueSoonEl.innerHTML = `<h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">${dueSoonLabel}</h3>` + (dueSoon.length > 0 ? dueSoon.map(t => `
                    <div class="p-3 rounded-lg mb-2 flex justify-between items-center hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <div><p class="font-medium text-gray-900 dark:text-white">${t.title}</p><p class="text-sm text-gray-500 dark:text-gray-400">${t.subject}</p></div>
                        <p class="text-sm font-semibold text-orange-600 dark:text-orange-400">${formatDate(t.dueDate)}</p>
                    </div>`).join('') : `<p class="text-gray-500 dark:text-gray-400 text-center py-4">No tasks due soon.</p>`);
            }

            function setupTasksPage() {
                const filters = ['All', 'Pending', 'In Progress', 'Completed'];
                const filterButtonsContainer = document.getElementById('filter-buttons');
                const taskListContainer = document.getElementById('full-task-list');
                const filtered = currentFilter === 'All' ? tasks : tasks.filter(t => t.status === currentFilter);

                const renderTaskList = () => {
                    const isOverdue = (dueDate, status) => {
                        if (status === 'Completed' || !dueDate) return false;
                        const due = new Date(dueDate);
                        const today = new Date();
                        today.setHours(0,0,0,0);
                        return due < today;
                    }
                    taskListContainer.innerHTML = filtered.length > 0 ? `<div class="divide-y divide-gray-200 dark:divide-gray-700">${filtered.map(task => `
                        <div class="p-6 flex items-start justify-between ${task.status === 'Completed' ? 'opacity-60' : ''}">
                            <div>
                               <h3 class="font-medium text-gray-900 dark:text-white ${task.status === 'Completed' ? 'line-through' : ''}">${task.title}</h3>
                               <div class="flex items-center gap-4 mt-2 text-sm text-gray-600 dark:text-gray-400">
                                   <div class="flex items-center gap-1.5"><i data-lucide="book-open" class="w-4 h-4"></i><span>${task.subject}</span></div>
                                   <div class="flex items-center gap-1.5">
                                       <i data-lucide="calendar" class="w-4 h-4"></i>
                                       <span class="${isOverdue(task.dueDate, task.status) ? 'text-red-500 font-medium' : ''}">
                                            Due ${formatDate(task.dueDate)}
                                            ${isOverdue(task.dueDate, task.status) ? ' (Overdue)' : ''}
                                       </span>
                                   </div>
                               </div>
                               <div class="mt-3"><select class="task-status-select text-xs px-3 py-1 rounded-full border font-medium bg-transparent status-badge-${task.status.replace(' ','-')}" data-id="${task.id}">${filters.slice(1).map(s => `<option value="${s}" ${task.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                            </div>
                            <div class="flex items-center gap-2">
                               <button class="edit-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg" data-id="${task.id}"><i data-lucide="edit-2" class="w-4 h-4 text-gray-500"></i></button>
                               <button class="delete-btn p-2 hover:bg-gray-100 dark:hover:bg-gray-700/50 rounded-lg" data-id="${task.id}"><i data-lucide="trash-2" class="w-4 h-4 text-gray-500"></i></button>
                            </div>
                        </div>`).join('')}</div>` : `<div class="text-center py-16"><i data-lucide="calendar" class="w-12 h-12 mx-auto text-gray-400"></i><h3 class="mt-2 text-lg font-medium text-gray-900 dark:text-white">No tasks yet</h3><p class="mt-1 text-sm text-gray-500">Add your first task to get started!</p></div>`;
                    lucide.createIcons();
                };

                filterButtonsContainer.innerHTML = `<div class="flex items-center gap-2"><i data-lucide="filter" class="w-5 h-5 text-gray-500"></i><span class="text-sm font-medium text-gray-700 dark:text-gray-300">Filter by status:</span></div>` + filters.map(f => `<button class="px-3 py-1 rounded-full text-sm font-medium ${currentFilter === f ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300'}" data-filter="${f}">${f}</button>`).join('') + `<div class="ml-auto text-sm text-gray-500 dark:text-gray-400">${filtered.length} tasks</div>`;
                
                filterButtonsContainer.addEventListener('click', e => { 
                    const button = e.target.closest('button');
                    if (button && button.dataset.filter) { 
                        currentFilter = button.dataset.filter;
                        renderPage('tasks'); 
                    }
                });

                taskListContainer.addEventListener('click', e => { const btn = e.target.closest('button'); if(btn){ const id = btn.dataset.id; if (btn.classList.contains('edit-btn')) openTaskModal(tasks.find(t=>t.id===id)); if (btn.classList.contains('delete-btn')) deleteTask(id); }});
                taskListContainer.addEventListener('change', e => { 
                    if (e.target.classList.contains('task-status-select')) { 
                        const {id} = e.target.dataset, {value} = e.target;
                        const task = tasks.find(t => t.id === id);
                        if (task) {
                            task.status = value;
                            if (value === 'Completed' && !task.completedAt) {
                                task.completedAt = new Date().toISOString();
                            } else if (value !== 'Completed' && task.completedAt) {
                                delete task.completedAt;
                            }
                        }
                        saveToFirebase(); 
                        renderTaskList(); 
                    }
                });
                document.getElementById('open-add-modal-btn').addEventListener('click', () => openTaskModal());
                renderTaskList();
            }
            
            function setupCalendarPage() {
                const container = document.getElementById('calendar-container');
                let currentDate = new Date();
                const renderCalendar = () => {
                    const year = currentDate.getFullYear(), month = currentDate.getMonth();
                    const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
                    const daysInMonth = lastDay.getDate(), startDayIndex = firstDay.getDay();
                    let html = `<div class="flex items-center justify-between mb-6">
                                    <button id="prev-month" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i data-lucide="chevron-left"></i></button>
                                    <h2 class="text-lg font-semibold">${currentDate.toLocaleString('default', { month: 'long' })} ${year}</h2>
                                    <button id="next-month" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg"><i data-lucide="chevron-right"></i></button>
                                </div>
                                <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-500 dark:text-gray-400 mb-2">
                                    ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div>${d}</div>`).join('')}
                                </div>
                                <div id="calendar-grid" class="grid grid-cols-7 gap-1">`;
                    for (let i = 0; i < startDayIndex; i++) html += `<div></div>`;
                    for (let day = 1; day <= daysInMonth; day++) {
                        const monthStr = String(month + 1).padStart(2, '0');
                        const dayStr = String(day).padStart(2, '0');
                        const dateStr = `${year}-${monthStr}-${dayStr}`;
                        const today = new Date();
                        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                        const dayTasks = tasks.filter(t => t.dueDate === dateStr);
                        const isToday = todayStr === dateStr;
                        const statusColor = (s) => ({'Completed': 'bg-green-500', 'In Progress': 'bg-blue-500', 'Pending': 'bg-yellow-500'})[s];
                        html += `<div class="min-h-[90px] p-1 border border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 calendar-day ${isToday ? 'ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/50' : 'bg-white dark:bg-gray-800/50'}" data-date="${dateStr}">
                                        <div class="font-medium text-sm ${isToday ? 'text-blue-700 dark:text-blue-300' : ''}">${day}</div>
                                        <div class="space-y-1 mt-1">${dayTasks.slice(0, 2).map(t => `<div class="text-xs px-1 py-0.5 rounded truncate text-white ${statusColor(t.status)}">${t.title}</div>`).join('')}
                                        ${dayTasks.length > 2 ? `<div class="text-xs text-gray-500 px-1">+${dayTasks.length - 2} more</div>` : ''}</div>
                                    </div>`;
                    }
                    html += `</div>`;
                    container.innerHTML = html;
                    
                    const infoSection = document.getElementById('calendar-info-section');
                    const now = new Date();
                    const thisMonthTasks = tasks.filter(task => {
                        if(!task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate.getMonth() === now.getMonth() && taskDate.getFullYear() === now.getFullYear();
                    }).length;
                    const oneWeekFromNow = new Date();
                    oneWeekFromNow.setDate(now.getDate() + 7);
                    const dueThisWeek = tasks.filter(task => {
                        if (task.status === 'Completed' || !task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate >= now && taskDate <= oneWeekFromNow;
                    }).length;
                    const overdueTasks = tasks.filter(task => {
                        if (task.status === 'Completed' || !task.dueDate) return false;
                        const taskDate = new Date(task.dueDate);
                        return taskDate < now;
                    }).length;

                    infoSection.innerHTML = `
                        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">How to Use</h3>
                            <ul class="space-y-3 text-sm text-gray-600 dark:text-gray-400">
                                <li class="flex items-start gap-3"><span class="w-2 h-2 mt-1.5 bg-blue-500 rounded-full"></span><span>Click on any date to see tasks scheduled for that day.</span></li>
                                <li class="flex items-start gap-3"><span class="w-2 h-2 mt-1.5 bg-green-500 rounded-full"></span><span>Colored dots indicate task status and subject.</span></li>
                                <li class="flex items-start gap-3"><span class="w-2 h-2 mt-1.5 bg-orange-500 rounded-full"></span><span>Today's date is highlighted with a blue border.</span></li>
                            </ul>
                        </div>
                        <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Quick Stats</h3>
                            <div class="space-y-3 text-sm">
                                <div class="flex justify-between"><span>This Month's Tasks</span><span class="font-medium">${thisMonthTasks}</span></div>
                                <div class="flex justify-between"><span>Due This Week</span><span class="font-medium">${dueThisWeek}</span></div>
                                <div class="flex justify-between"><span>Overdue Tasks</span><span class="font-medium text-red-500">${overdueTasks}</span></div>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                    container.querySelector('#prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
                    container.querySelector('#next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });
                    document.getElementById('calendar-grid').addEventListener('click', (e) => {
                        const dayCell = e.target.closest('.calendar-day');
                        if(dayCell && dayCell.dataset.date) {
                            openDateTasksModal(dayCell.dataset.date);
                        }
                    });
                };
                renderCalendar();
            }

            function setupAnalyticsPage() {
                const total = tasks.length;
                const completedTasks = tasks.filter(t => t.status === 'Completed');
                const completed = completedTasks.length;
                const overdue = tasks.filter(t => t.status !== 'Completed' && new Date(t.dueDate) < new Date()).length;
                const completionRate = total > 0 ? Math.round(completed/total*100) : 0;
                
                // --- 1. Top Metrics ---
                const subjectStats = tasks.reduce((acc, t) => { 
                    acc[t.subject] = acc[t.subject] || { total: 0, completed: 0 }; 
                    acc[t.subject].total++; 
                    if (t.status === 'Completed') acc[t.subject].completed++; 
                    return acc; 
                }, {});

                const icons = {'Completion Rate':'target', 'Overdue Tasks':'calendar', 'Active Subjects':'bar-chart-3'};
                document.getElementById('analytics-key-metrics').innerHTML = [
                    { label: 'Completion Rate', value: `${completionRate}%` },
                    { label: 'Overdue Tasks', value: overdue },
                    { label: 'Active Subjects', value: Object.keys(subjectStats).length }
                ].map(m => `
                    <div class="bg-white dark:bg-gray-900 p-6 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex justify-between items-center">
                        <div><p class="text-sm text-gray-500 dark:text-gray-400">${m.label}</p><p class="text-2xl font-bold dark:text-white">${m.value}</p></div>
                        <div class="p-3 bg-blue-50 dark:bg-blue-900/50 rounded-lg"><i data-lucide="${icons[m.label]}"></i></div>
                    </div>`).join('');

                // --- 2. Subject Performance ---
                document.getElementById('analytics-subject-performance').innerHTML = 
                    `<h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Subject Performance</h3>` + 
                    (Object.keys(subjectStats).length > 0 ? Object.entries(subjectStats).map(([sub, stats]) => { 
                        const rate = stats.total > 0 ? Math.round(stats.completed / stats.total * 100) : 0; 
                        return `<div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-800 dark:text-gray-200 font-medium">${sub}</span>
                                <span class="text-gray-500">${rate}%</span>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-2.5">
                                <div class="bg-blue-500 h-2.5 rounded-full transition-all duration-500" style="width: ${rate}%"></div>
                            </div>
                        </div>`; 
                    }).join('') : `<p class="text-gray-500 text-center py-4">No data available.</p>`);

                // --- 3. DAILY ACTIVITY CHART (With Navigation & Size Fix) ---
                const weeklyProgressContainer = document.getElementById('analytics-weekly-progress');
                weeklyProgressContainer.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Daily Activity</h3>
                        <div class="flex items-center gap-2 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
                            <button id="chart-prev-btn" class="p-1 hover:bg-white dark:hover:bg-gray-700 rounded shadow-sm transition-all disabled:opacity-40"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <span id="chart-date-label" class="text-xs font-medium px-2 min-w-[80px] text-center">Last 7 Days</span>
                            <button id="chart-next-btn" class="p-1 hover:bg-white dark:hover:bg-gray-700 rounded shadow-sm transition-all disabled:opacity-40" disabled><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                    <div style="position: relative; height: 240px; width: 100%;">
                        <canvas id="activityChart"></canvas>
                    </div>`;

                let weekOffset = 0; // 0 = current week, 1 = 1 week ago...

                const renderChart = () => {
                    // Update buttons
                    const nextBtn = document.getElementById('chart-next-btn');
                    const prevBtn = document.getElementById('chart-prev-btn');
                    const labelEl = document.getElementById('chart-date-label');
                    
                    if (nextBtn) nextBtn.disabled = weekOffset === 0;
                    
                    if (labelEl) {
                        if (weekOffset === 0) labelEl.textContent = "Last 7 Days";
                        else if (weekOffset === 1) labelEl.textContent = "Last Week";
                        else labelEl.textContent = `${weekOffset} Weeks Ago`;
                    }

                    // --- NEW LOGIC: Disable Prev button if no older data ---
                    // Calculate start of currently viewed window
                    const currentWindowEnd = new Date();
                    currentWindowEnd.setDate(currentWindowEnd.getDate() - (weekOffset * 7));
                    
                    const currentWindowStart = new Date(currentWindowEnd);
                    currentWindowStart.setDate(currentWindowStart.getDate() - 6);
                    currentWindowStart.setHours(0,0,0,0); // Start of the first day in view

                    // Check if there is any completed task older than this start date
                    const hasOlderData = tasks.some(t => {
                        if (t.status === 'Completed' && t.completedAt) {
                            return new Date(t.completedAt).getTime() < currentWindowStart.getTime();
                        }
                        return false;
                    });

                    if (prevBtn) prevBtn.disabled = !hasOlderData;
                    // -----------------------------------------------------

                    // Calculate Data
                    const labels = [];
                    const dataPoints = [];
                    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                    
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date(currentWindowEnd);
                        d.setDate(d.getDate() - i);
                        
                        const dayName = (weekOffset === 0 && i === 0) ? 'Today' : days[d.getDay()];
                        labels.push(dayName);

                        const startOfDay = new Date(d.setHours(0,0,0,0));
                        const endOfDay = new Date(d.setHours(23,59,59,999));
                        
                        const count = tasks.filter(t => {
                            if (t.status !== 'Completed' || !t.completedAt) return false;
                            const completeDate = new Date(t.completedAt);
                            return completeDate >= startOfDay && completeDate <= endOfDay;
                        }).length;
                        
                        dataPoints.push(count);
                    }

                    if (analyticsChart) analyticsChart.destroy();

                    const canvas = document.getElementById('activityChart');
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    const textColor = isDark ? '#9ca3af' : '#4b5563'; 

                    analyticsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Tasks',
                                data: dataPoints,
                                backgroundColor: '#c026d3', 
                                hoverBackgroundColor: '#d946ef',
                                borderRadius: 6,            
                                borderSkipped: false,
                                maxBarThickness: 40, // Prevents glitch
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false, 
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    enabled: true,
                                    backgroundColor: isDark ? '#374151' : '#1f2937',
                                    padding: 10,
                                    cornerRadius: 8,
                                    displayColors: false,
                                    callbacks: { title: () => null, label: (c) => `${c.raw} Tasks` }
                                }
                            },
                            scales: {
                                y: { display: false, beginAtZero: true },
                                x: {
                                    grid: { display: false, drawBorder: false },
                                    border: { display: false }, 
                                    ticks: { color: textColor, font: { family: "'Inter', sans-serif", size: 11 } }
                                }
                            }
                        }
                    });
                };

                // Initial Render
                renderChart();

                // Listeners
                const prevBtn = document.getElementById('chart-prev-btn');
                const nextBtn = document.getElementById('chart-next-btn');
                
                if(prevBtn) prevBtn.addEventListener('click', () => { weekOffset++; renderChart(); });
                if(nextBtn) nextBtn.addEventListener('click', () => { if(weekOffset > 0) weekOffset--; renderChart(); });

                // --- 4. Insights (FIXED OVERFLOW & FLEX) ---
                document.getElementById('analytics-study-insights').innerHTML = `
                    <h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-white">Insights</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="p-5 bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl flex flex-col justify-center">
                            <h4 class="font-semibold text-green-800 dark:text-green-300 mb-2 flex items-center gap-2">
                                <i data-lucide="trending-up" class="w-4 h-4"></i> Productivity Peak
                            </h4>
                            <p class="text-sm text-green-700 dark:text-green-400 leading-relaxed">
                                Keep up the good work! Your best performance is usually on <strong>Today</strong>.
                            </p>
                        </div>
                        <div class="p-5 bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl flex flex-col justify-center">
                            <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-2 flex items-center gap-2">
                                <i data-lucide="activity" class="w-4 h-4"></i> Consistency
                            </h4>
                            <p class="text-sm text-blue-700 dark:text-blue-400 leading-relaxed">
                                You have been active for <strong>${tasks.length > 0 ? '1' : '0'}/7</strong> days this week.
                            </p>
                        </div>
                    </div>`;
                
                lucide.createIcons();
            }

            function setupSettingsPage() {
                const preferencesEl = document.getElementById('settings-preferences');
                
                const reminderOptions = [
                    { value: 1, label: '1 Hour' }, { value: 10, label: '10 Hours' },
                    { value: 24, label: '24 Hours' }, { value: 48, label: '48 Hours' },
                    { value: 168, label: '1 Week' }
                ];

                preferencesEl.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3"><i data-lucide="bell" class="text-gray-500 dark:text-gray-400"></i><div><h4 class="text-gray-900 dark:text-white">Notifications</h4><p class="text-sm text-gray-500 dark:text-gray-400">Remind you of upcoming deadlines</p></div></div>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="notifications-toggle" class="sr-only peer"><div class="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:bg-blue-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all"></div></label>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3"><i data-lucide="clock" class="text-gray-500 dark:text-gray-400"></i><div><h4 class="text-gray-900 dark:text-white">Reminder Time</h4><p class="text-sm text-gray-500 dark:text-gray-400">Hours before due date</p></div></div>
                        <select id="reminder-time-select" class="p-2 border rounded dark:bg-gray-700 bg-white dark:border-gray-600">
                            ${reminderOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                        </select>
                    </div>`;
                
                document.getElementById('notifications-toggle').checked = settings.notifications;
                document.getElementById('reminder-time-select').value = settings.reminderTime;

                document.getElementById('notifications-toggle').addEventListener('change', handleNotificationToggle);
                document.getElementById('reminder-time-select').addEventListener('change', (e) => {
                    settings.reminderTime = parseInt(e.target.value);
                    saveToFirebase();
                });
                
                document.getElementById('settings-data-management').innerHTML = `<button id="export-data-btn" class="p-4 border dark:border-gray-700 rounded-lg text-left hover:bg-gray-50 dark:hover:bg-gray-700/50"><i data-lucide="upload" class="mb-2 text-blue-600"></i><h4 class="font-semibold text-gray-900 dark:text-white">Export Data</h4><p class="text-sm text-gray-500 dark:text-gray-400">Download backup</p></button><label class="p-4 border dark:border-gray-700 rounded-lg text-left cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50"><i data-lucide="download" class="mb-2 text-green-600"></i><h4 class="font-semibold text-gray-900 dark:text-white">Import Data</h4><p class="text-sm text-gray-500 dark:text-gray-400">Restore from backup</p><input type="file" id="import-file-input" class="hidden" accept=".json"></label><button id="clear-data-btn" class="p-4 border border-red-200 dark:border-red-800 text-red-500 rounded-lg text-left hover:bg-red-50 dark:hover:bg-red-900/50"><i data-lucide="trash-2" class="mb-2"></i><h4 class="font-semibold">Clear All Data</h4><p class="text-sm">Delete everything</p></button>`;
                document.getElementById('export-data-btn').addEventListener('click', exportData); document.getElementById('import-file-input').addEventListener('change', importData); document.getElementById('clear-data-btn').addEventListener('click', clearData);
                document.getElementById('settings-about').innerHTML = `<div><span>Version</span><span class="font-medium float-right">2.1.0 (Chart.js Update)</span></div><div><span>Last Updated</span><span class="font-medium float-right">${new Date().toLocaleDateString()}</span></div><div><span>Data Storage</span><span class="font-medium float-right">Firebase Realtime DB</span></div><p class="mt-4 pt-4 border-t dark:border-gray-700">Study Planner helps students organize their academic tasks...</p>`;
            }

            function openTaskModal(task = null) {
                const form = document.getElementById('task-form');
                document.getElementById('modal-title').textContent = task ? 'Edit Task' : 'Add New Task';
                form.innerHTML = `<input type="hidden" name="id" value="${task ? task.id : ''}">
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Task Title</label><input type="text" name="title" required class="mt-1 w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600" value="${task ? task.title : ''}"></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Subject</label><input type="text" name="subject" required class="mt-1 w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600" value="${task ? task.subject : ''}"></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Due Date</label><input type="date" name="dueDate" required class="mt-1 w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600" value="${task ? task.dueDate : ''}"></div>
                    <div><label class="text-sm font-medium text-gray-700 dark:text-gray-300">Status</label><select name="status" class="mt-1 w-full p-2 border rounded bg-white dark:bg-gray-700 dark:border-gray-600">${['Pending', 'In Progress', 'Completed'].map(s => `<option value="${s}" ${task && task.status === s ? 'selected' : ''}>${s}</option>`).join('')}</select></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-2.5 rounded-lg hover:bg-blue-700">${task ? 'Update Task' : 'Add Task'}</button>`;
                document.getElementById('task-modal').classList.remove('hidden');
            }

            function openDateTasksModal(dateStr) {
                const modal = document.getElementById('date-tasks-modal');
                const titleEl = document.getElementById('date-tasks-modal-title');
                const contentEl = document.getElementById('date-tasks-modal-content');
                
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(Date.UTC(year, month - 1, day));
                const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });
                
                titleEl.textContent = `Tasks for ${formattedDate}`;

                const dayTasks = tasks.filter(t => t.dueDate === dateStr);
                if (dayTasks.length > 0) {
                    contentEl.innerHTML = `<div class="space-y-3">${dayTasks.map(task => {
                        const statusColor = {'Pending': 'bg-yellow-500', 'In Progress': 'bg-blue-500', 'Completed': 'bg-green-500'}[task.status];
                        return `<div class="p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg flex items-start gap-3">
                                    <div class="w-2 h-2 mt-1.5 rounded-full ${statusColor} flex-shrink-0"></div>
                                    <div>
                                        <p class="font-medium text-gray-900 dark:text-white">${task.title}</p>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${task.subject}</p>
                                    </div>
                                </div>`;
                    }).join('')}</div>`;
                } else {
                    contentEl.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center">No tasks scheduled for this day.</p>';
                }
                modal.classList.remove('hidden');
            }

            function saveTask(e) { e.preventDefault(); const data = new FormData(e.target), id = data.get('id'); const taskData = { title: data.get('title'), subject: data.get('subject'), dueDate: data.get('dueDate'), status: data.get('status') }; if (id) { const existingTask = tasks.find(t=>t.id===id); if (existingTask.dueDate !== taskData.dueDate) { delete existingTask.notified; } Object.assign(existingTask, taskData); if (existingTask.status === 'Completed' && !existingTask.completedAt) { existingTask.completedAt = new Date().toISOString(); } } else { tasks.push({ ...taskData, id: crypto.randomUUID(), createdAt: new Date().toISOString() }); } saveToFirebase(); closeModal(); renderPage(window.location.hash.slice(2) || 'dashboard'); }
            function deleteTask(id) { if (confirm('Are you sure you want to delete this task?')) { tasks = tasks.filter(t => t.id !== id); saveToFirebase(); renderPage(window.location.hash.slice(2) || 'dashboard'); } }
            const closeModal = () => document.getElementById('task-modal').classList.add('hidden');
            
            function handleNotificationToggle(e) {
                const enabled = e.target.checked;
                if (enabled && Notification.permission !== 'granted') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            settings.notifications = true;
                            saveToFirebase();
                        } else {
                            alert('Notifications permission was denied.');
                            e.target.checked = false;
                        }
                    });
                } else {
                    settings.notifications = enabled;
                    saveToFirebase();
                }
            }

            function checkAndSendNotifications() {
                if (!settings.notifications || Notification.permission !== 'granted') return;
                const now = new Date().getTime();
                const reminderWindow = settings.reminderTime * 60 * 60 * 1000;
                tasks.forEach(task => {
                    if (task.status !== 'Completed' && task.dueDate) {
                        const dueDate = new Date(task.dueDate).getTime();
                        const timeUntilDue = dueDate - now;
                        if (timeUntilDue > 0 && timeUntilDue <= reminderWindow && !task.notified) {
                            new Notification('AcademiaPlan Reminder', { body: `Task "${task.title}" is due soon!` });
                            task.notified = true;
                            saveToFirebase();
                        }
                    }
                });
            }

            const exportData = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({tasks, settings}, null, 2)], {type:'application/json'})); a.download = 'academiaplan-backup.json'; a.click(); };
            const importData = (e) => { const reader = new FileReader(); reader.onload = (ev) => { try { const imported = JSON.parse(ev.target.result); if(Array.isArray(imported.tasks) && typeof imported.settings === 'object') { tasks = imported.tasks; settings = imported.settings; saveToFirebase(); renderPage('dashboard'); alert('Data imported successfully!'); } else { alert('Invalid file format.'); } } catch { alert('Invalid file format.'); } }; reader.readAsText(e.target.files[0]); };
            const clearData = () => { if (confirm('This will delete all your tasks and settings permanently. This action cannot be undone.')) { tasks = []; settings = { notifications: false, reminderTime: 24 }; saveToFirebase(); renderPage('dashboard'); } };
            
            const navigate = () => renderPage(window.location.hash.slice(2) || 'dashboard');
            window.addEventListener('hashchange', navigate);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', () => { if(window.innerWidth < 1024) document.getElementById('sidebar').classList.add('-translate-x-full'); }));
            navigate();
            document.getElementById('mobile-menu-button').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('-translate-x-full'));
            document.getElementById('task-form').addEventListener('submit', saveTask);
            document.getElementById('modal-close').addEventListener('click', closeModal);
            document.querySelector('#task-modal .modal-overlay').addEventListener('click', closeModal);

            const dateTasksModal = document.getElementById('date-tasks-modal');
            dateTasksModal.querySelector('#date-tasks-modal-close').addEventListener('click', () => dateTasksModal.classList.add('hidden'));
            dateTasksModal.querySelector('.modal-overlay').addEventListener('click', () => dateTasksModal.classList.add('hidden'));
            
            setInterval(checkAndSendNotifications, 60000); 
        }
    </script>
</body>
</html>
